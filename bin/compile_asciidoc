#!/bin/bash 

usage()
{
    echo
    echo "Usage: $(basename $0) [--help] [--file \"ADFILE\"]"
    echo
    echo "If an ASCIIDoc file is not provided, current directory is searched for one."
    echo "All other arguments are ignored."
    echo
}


# Default options
adfile=

# Get command line options 
while [ "$1" ]; do 
    case "$1" in 
        -h | --help)
        usage
        exit 0
        ;;
        -f | --file)
        adfile="$2"
        shift 2
        ;;
        *)
        echo "Error: invalid command line option, $1"
        usage
        exit 1
        ;;
    esac
done
     
# Validate
if [ -z "$adfile" ]; then
    adfile="$(ls | grep '.*\.asciidoc$')"
    num_adfiles=$(ls | grep '.*\.asciidoc$' | wc -l)
    if [ $num_adfiles -le 0 ]; then
        echo "Error: no automatic ASCIIDoc file found."
        exit 1
    elif [ $num_adfiles -gt 1 ]; then
        echo "Error: too many ASCIIDoc files found, '$adfile'."
        exit 1
    else
        echo "Automatic ASCIIDoc file found, '$adfile'."
    fi
elif [ ! -e "$adfile" ]; then
    echo "Error: ASCIIDoc file '$adfile' does not exists."
    exit 1
fi

# Compiling commands
base_adfile="${adfile%.*}"
#ad_cmd="asciidoc -b docbook $adfile"
ad_cmd="a2x -d article -f pdf $adfile"
dblatex_cmd="dblatex $base_adfile.xml -T simple"

# Viewer commands
view_cmd="evince $base_adfile.pdf"

# Run
eval "$ad_cmd"
#eval "$dblatex_cmd" && rm "$base_adfile.xml"
eval "$view_cmd & disown"

unset adfile num_adfiles base_adfile ad_cmd dblatex_cmd view_cmd
exit 0

