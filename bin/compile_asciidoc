#!/bin/bash 

usage()
{
    echo
    echo "Usage: $(basename $0) [--help] [--article] [--book] [--docbook] [--file \"ADFILE\"]"
    echo
    echo "Compile an ASCIIDoc file into PDF format."
    echo
    echo "If an ASCIIDoc file is not provided, current directory is searched for one."
    echo "Default file type is article."
    echo
}

# Default options
adtype=0
adffile=
filext=".asciidoc"

# Get command line options 
while [ "$1" ]; do 
    case "$1" in 
        -h | --help)
            usage
            exit 0
            ;;
        -a | --article)
            adtype=0
            shift
            ;;
        -b | --book)
            adtype=1
            shift
            ;;
        -d | --docbook)
            adtype=2
            shift
            ;;
        -f | --file)
            adffile="$2"
            shift 2
            ;;
        *)
            echo "Error: invalid command line option, $1"
            usage
            exit 1
            ;;
    esac
done
     
# Validate
if [ -z "$adffile" ]; then
    . common_utils
    find_file_ext "$filext" 
    [ $? -eq 0 ] || exit 1
    adffile="$file_list"
elif [ ! -e "$adffile" ]; then
    echo "Error: file '$adffile' does not exists."
    exit 1
fi

# Commands (compile and view)
addir="$(dirname $adffile)"
adfile="$(basename $adffile)"
adbase="${adfile%.*}"
adpdf="$adbase.pdf"
adxml="$adbase.xml"
dblatex_cmd="dblatex $adxml -T simple"
view_cmd="evince $adpdf"

case $adtype in
    0) ad_cmd="a2x -d article -f pdf $adfile" ;;
    1) ad_cmd="a2x -d book -f pdf $adfile" ;;
    2) ad_cmd="asciidoc -b docbook $adfile" ;;
esac

# Change to file directory
pushd . > /dev/null 2>&1
cd "$addir"

# Run
$ad_cmd
if [ -e "$adxml" ]; then
    $dblatex_cmd
    rm "$adxml"
fi

# View
if [ -e "$adpdf" ]; then
    $view_cmd & disown
fi

# Change to initial directory
popd > /dev/null 2>&1

exit 0

