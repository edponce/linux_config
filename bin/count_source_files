#!/bin/bash

. $HOME/bin/error_utils

usage()
{
cat << _EOF_
Usage: $(basename $0) [--help] [--list] [--recursive] [--workdir "WORKDIR"] ".EXT1" [".EXT2"] ...

Count files that match given extensions.

Default working directory is current directory.
Files are displayed by enabling listing option.
Default is to not operate recursively.
Hidden/temporary files are ignored.
_EOF_
}

# Default options
list=0
recursive=
workdir="."
filext=()

# Get command line options 
while [ "$1" ]; do 
    case "$1" in 
        -h | --help)
            usage
            exit 0
            ;;
        -l | --list)
            list=1
            shift
            ;;
        -r | --recursive)
            recursive="-R"
            shift
            ;;
        -w | --workdir)
            workdir="$2"
            shift 2
            ;; 
        *)
            if [ "${1:0:1}" = "." ]; then
                filext+=("$(echo "$1" | sed 's/\./\\\./g')")
            else
                filext+=("\.$1")
            fi
            shift
            ;;
    esac
done

# Validate
if [ ! -d "$workdir" ]; then
    error_msg "working directory does not exists" 1
fi

if [ ${#filext[@]} -eq 0 ]; then
    error_msg "no file extensions were provided" 1
fi

# Change to file directory
pushd . > /dev/null 2>&1
cd "$workdir"

# List files recursively, ignore hidden files
# Filter source files and count
file_regex=$(IFS='|'; echo "${filext[*]}")
file_list=($(ls -1 $recursive | grep -E "^\w+($file_regex)$"))
num_files=${#file_list[@]}

if [ $list -eq 1 ]; then
    IFS=$'\n'; echo "${file_list[*]}"
fi
echo "Number of matched files: $num_files"

# Change to initial directory
popd > /dev/null 2>&1

exit 0

