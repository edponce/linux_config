#!/bin/bash 

usage()
{
    echo
    echo "Usage: $(basename $0) [--help] [--bibtex] [--clean] [--pdfpc] [--workdir \"WORDIR\"] [--file \"TeXFILE\"]"
    echo
    echo "Compile a LaTeX file into PDF format."
    echo
    echo "If a LaTeX file is not provided, current directory is searched for one."
    echo "Default working directory is 'build'."
    echo "To remove working directory after compiling, enable the 'clean' option."
    echo "To run bibTeX enable the 'bibtex' option."
    echo "To view as Beamer presentation with pdfpc, enable 'pc' option."
    echo
}

# Default options
bibtex=0
clean=0
pdfpc=0
workdir="build"
texffile=
filext=".tex"

# Get command line options 
while [ "$1" ]; do 
    case "$1" in 
        -h | --help)
            usage
            exit 0
            ;;
        -b | --bibtex)
            bibtex=1
            shift
            ;;
        -c | --clean)
            clean=1
            shift
            ;;
        -p | --pdfpc)
            pdfpc=1
            shift
            ;;
        -w | --workdir)
            workdir="$2"
            shift 2
            ;;
        -f | --file)
            texffile="$2"
            shift 2
            ;;
        *)
            echo "Error: invalid command line option, $1"
            usage
            exit 1
            ;;
    esac
done

# Validate
if [ -z "$texffile" ]; then
    . common_utils
    find_file_ext "$filext" 
    [ $? -ne 0 ] && exit 1
    texffile="$file_list"
elif [ ! -e "$texffile" ]; then
    echo "Error: file '$texffile' does not exists."
    exit 1
fi

# Commands (compile and view) 
texdir="$(dirname $texffile)"
texfile="$(basename $texffile)"
texbase="${texfile%.*}"
texpdf="$texbase.pdf"
pdflatex_cmd="pdflatex -synctex=1 -interaction=nonstopmode -output-dir=$workdir $texfile"
bibtex_cmd="bibtex $workdir/$texbase"

# Change to file directory
pushd . > /dev/null 2>&1
cd "$texdir"

[ ! -d "$workdir" ] && mkdir "$workdir"

# Run
$pdflatex_cmd
[ $? -ne 0 ] && exit 1
if [ $bibtex -ge 1 ]; then
    $bibtex_cmd
    $pdflatex_cmd
    $pdflatex_cmd
fi

# View
if [ $clean -eq 0 ]; then
    texpdf="$workdir/$texpdf"
else
    mv "$workdir/$texpdf" "$texpdf"
    rm -r "$workdir"
fi
if [ $pdfpc -eq 0 ]; then
    view_cmd="evince $texpdf"
else
    view_cmd="pdfpc $texpdf"
fi
$view_cmd & disown

# Change to initial directory
popd > /dev/null 2>&1

exit 0

