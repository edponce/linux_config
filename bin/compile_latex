#!/bin/bash 

. $HOME/bin/error_utils
. $HOME/bin/common_utils

usage()
{
cat << _EOF_

Usage: $(basename $0) [--help] [--bibtex] [--clean] [--pdfpc] [--workdir "WORDIR"] [--file "TeXFILE"]

Compile a LaTeX file into PDF format.

If a LaTeX file is not provided, current directory is searched for one.
Default working directory is 'build'.
To remove working directory after compiling, enable the 'clean' option.
To run bibTeX enable the 'bibtex' option.
To view as Beamer presentation with pdfpc, enable 'pc' option.

_EOF_
}

# Default options
bibtex=0
clean=0
pdfpc=0
workdir="build"
texffile=
filext=".tex"

# Get command line options 
while [ "$1" ]; do 
    case "$1" in 
        -h | --help)
            usage
            exit 0
            ;;
        -b | --bibtex)
            bibtex=1
            shift
            ;;
        -c | --clean)
            clean=1
            shift
            ;;
        -p | --pdfpc)
            pdfpc=1
            shift
            ;;
        -w | --workdir)
            workdir="$2"
            shift 2
            ;;
        -f | --file)
            texffile="$2"
            shift 2
            ;;
        *)
            usage
            error_msg "invalid command line option, $1" 1
            ;;
    esac
done

# Validate
if [ -z "$texffile" ]; then
    find_file_ext "$filext" 
    [ $? -eq 0 ] || exit 1
    texffile="$file_list"
fi
if [ ! -e "$texffile" ]; then
    error_msg "file '$texffile' does not exists" 1
fi

# Commands (compile and view) 
texdir="$(dirname $texffile)"
texfile="$(basename $texffile)"
texbase="${texfile%.*}"
texpdf="$texbase.pdf"
pdflatex_cmd="pdflatex -synctex=1 -interaction=nonstopmode -output-dir=$workdir $texfile"
bibtex_cmd="bibtex $workdir/$texbase"
case $pdfpc in
    0) view_cmd="evince" ;;
    *) view_cmd="pdfpc" ;;
esac

# Change to file directory
pushd . > /dev/null 2>&1
cd "$texdir"

[ ! -d "$workdir" ] && mkdir "$workdir"

# Run
$pdflatex_cmd
[ $? -eq 0 ] || exit 1
if [ $bibtex -ge 1 ]; then
    $bibtex_cmd
    $pdflatex_cmd
    $pdflatex_cmd
fi

# View
if [ $clean -eq 0 ]; then
    texpdf="$workdir/$texpdf"
else
    mv "$workdir/$texpdf" "$texpdf"
    rm -r "$workdir"
fi

[ -e "$texpdf" ] && $view_cmd "$texpdf" &

# Change to initial directory
popd > /dev/null 2>&1

exit 0

