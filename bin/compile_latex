#!/bin/bash 

usage()
{
    echo
    echo "Usage: $(basename $0) [--help] [--bibtex] [--clean] [--pdfpc] [--workdir \"WORDIR\"] [--file \"TeXFILE\"]"
    echo
    echo "Compile a LaTeX file into PDF format."
    echo "If a LaTeX file is not provided, current directory is searched for one."
    echo "Default working directory is 'build'."
    echo "To remove working directory after compiling, enable the 'clean' option."
    echo "To run bibTeX enable the 'bibtex' option."
    echo "To view as Beamer presentation with pdfpc, enable 'pc' option."
    echo "All other arguments are passed directly to pdfpc command line."
    echo
}

# Default options
bibtex=0
clean=0
pdfpc=0
pdfpc_opts=
workdir="build"
ftexfile=

# Get command line options 
while [ "$1" ]; do 
    case "$1" in 
        -h | --help)
        usage
        exit 0
        ;;
        -b | --bibtex)
        bibtex=1
        shift 1
        ;;
        -c | --clean)
        clean=1
        shift 1
        ;;
        -w | --workdir)
        workdir="$2"
        shift 2
        ;;
        -p | --pdfpc)
        pdfpc=1
        shift 1
        ;;
        -f | --file)
        ftexfile="$2"
        shift 2
        ;;
        *)
        if [ $pdfpc -eq 1 ]; then
            pdfpc_opts+="$@"
            shift ${#@}
        else
            echo "Error: invalid command line option, $1"
            usage
            exit 1
        fi
        ;;
    esac
done

# Validate
if [ -z "$ftexfile" ]; then
    ftexfile="$(ls | grep '.*\.tex$')"
    num_texfiles=$(echo -n "$ftexfile" | wc -l)
    if [ $num_texfiles -eq 1 ]; then
        echo "Automatic TeX file found, '$ftexfile'."
    elif [ $num_texfiles -le 0 ]; then
        echo "Error: no automatic TeX file found."
        exit 1
    elif [ $num_texfiles -gt 1 ]; then
        echo "Error: too many TeX files found, '$ftexfile'."
        exit 1
    fi
elif [ ! -e "$ftexfile" ]; then
    echo "Error: TeX file '$texfile' does not exists."
    exit 1
fi

# Commands (compile and view) 
dir_texfile="$(dirname $ftexfile)"
texfile="$(basename $ftexfile)"
base_texfile="${texfile%.*}"
pdf_texfile="$base_texfile.pdf"
pdflatex_cmd="pdflatex -synctex=1 -interaction=nonstopmode -output-dir=$workdir $texfile"
bibtex_cmd="bibtex $workdir/$base_texfile"

# Change to file directory
pushd .
cd "$dir_texfile"

[ ! -d "$workdir" ] && mkdir "$workdir"

# Run
eval "$pdflatex_cmd"
if [ -e "$workdir/$pdf_texfile" ]; then 
    if [ $bibtex -ge 1 ]; then
        eval "$bibtex_cmd"
        eval "$pdflatex_cmd"
        eval "$pdflatex_cmd"
    fi

    # View
    if [ $clean -ge 1 ]; then
        mv "$workdir/$pdf_texfile" "$pdf_texfile"
        rm -r "$workdir"
        if [ $pdfpc -eq 0 ]; then
            view_cmd="evince $pdf_texfile"
        else
            view_cmd="pdfpc $pdfpc_opts $pdf_texfile"
        fi
    else
        if [ $pdfpc -eq 0 ]; then
            view_cmd="evince $workdir/$pdf_texfile"
        else
            view_cmd="pdfpc $pdfpc_opts $workdir/$pdf_texfile"
        fi
    fi
    eval "$view_cmd & disown"
fi

# Change to initial directory
popd

unset bibtex workdir pdfpc pdfpc_opts ftexfile num_texfiles texfile base_texfile dir_texfile pdf_texfile pdflatex_cmd bibtex_cmd view_cmd
exit 0

