#!/bin/sh

. "$HOME/bin/common_utils"
errmsg="\033[01;31mERROR\033[00m"
warnmsg="\033[01;33mWARNING\033[00m"

usage()
{
cat << _USAGE_
Usage: $(basename $0) [--help] [--bibtex] [--clean] [--pdfpc] [--workdir "WORDIR"] [--file "TeXFILE"]

Compile a LaTeX file into PDF format.

If a LaTeX file is not provided, current directory is searched for one.
Default working directory is 'build'.
To remove working directory after compiling, enable the 'clean' option.
To run bibTeX enable the 'bibtex' option.
To view as Beamer presentation with pdfpc, enable 'pc' option.
_USAGE_
}

# Default options
bibtex=0
clean=0
pdfpc=0
workdir="build"
texffile=""
filext=".tex"

# Get command line options
while [ "$1" ]; do
    case "$1" in
        -h | --help) usage
            exit 0 ;;
        -b | --bibtex) bibtex=1
            shift ;;
        -c | --clean) clean=1
            shift ;;
        -p | --pdfpc) pdfpc=1
            shift ;;
        -w | --workdir) workdir="$2"
            shift 2 ;;
        -f | --file) texffile="$2"
            shift 2 ;;
        *) usage
            printf "%b\n" "$errmsg: invalid command line option, $1"
            exit 1 ;;
    esac
done

# Validate
[ -z "$texffile" ] && texffile="$(find_file_ext "$filext")"
if [ ! -f "$texffile" ]; then
    printf "%b\n" "$errmsg: file '$texffile' does not exists"
    exit 1
fi

# Commands (compile and view)
texdir="$(dirname "$texffile")"
texfile="$(basename "$texffile")"
texbase="${texfile%.*}"
texpdf="$texbase.pdf"
pdflatex_cmd="pdflatex -synctex=1 -interaction=nonstopmode -output-dir=\"$workdir\" \"$texfile\""
bibtex_cmd="bibtex \"$workdir/$texbase\""
case $pdfpc in
    0) view_cmd="evince \"$workdir/$texpdf\"" ;;
    1) view_cmd="pdfpc \"$workdir/$texpdf\"" ;;
esac

# Change to file directory
pushd . > /dev/null 2>&1
cd "$texdir"

[ ! -d "$workdir" ] && mkdir "$workdir"

# Run
eval $pdflatex_cmd; [ $? -eq 0 ] || exit 1
if [ $bibtex -ge 1 ]; then
    eval $bibtex_cmd; [ $? -eq 0 ] || exit 1
    eval $pdflatex_cmd; [ $? -eq 0 ] || exit 1
fi
eval $pdflatex_cmd; [ $? -eq 0 ] || exit 1

# Clean and view
if [ $clean -eq 0 ]; then
    [ -f "$workdir/$texpdf" ] && eval $view_cmd &
else
    mv "$workdir/$texpdf" "$texpdf"
    rm -r "$workdir"
fi

# Change to initial directory
popd > /dev/null 2>&1

