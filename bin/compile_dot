#!/bin/bash

. $HOME/bin/error_utils
. $HOME/bin/common_utils

usage()
{
    echo
    echo "Usage: $(basename $0) [--help] [--tex] [--file=\"DOTFILE\"]"
    echo
    echo "Compile a DOT file into PNG or TeX format."
    echo "If a DOT file is not provided, current directory is search for one."
    echo "To generate TeX output format, enable 'tex' option."
    echo
}

# Default options
tex=0
dotffile=
filext=".dot"

# Get command line options
while [ "$1" ]; do 
    case "$1" in 
        -h | --help)
            usage
            exit 0
            ;;
        -t | --tex)
            tex=1
            shift
            ;;
        -f | --file)
            dotffile="$2"
            shift 2
            ;;
        *)
            usage
            error_msg "invalid command line option, $1" 1
            ;;
    esac
done

# Validate
if [ -z "$dotffile" ]; then
    find_file_ext "$filext"
    [ $? -eq 0 ] || exit 1
    dotffile="$file_list"
fi
if [ ! -e "$dotffile" ]; then
    error_msg "file '$dotffile' does not exists" 1
fi

# Commands (compile and view) 
dotdir="$(dirname $dotffile)"
dotfile="$(basename $dotffile)"
dotbase="${dotfile%.*}"
dotpng="$dotbase.png"
dottex="$dotbase.tex"
view_cmd="gpicview"
case $tex in
    0) dot_cmd="dot -Tpng $dotfile -o $dotpng" ;;
    1) dot_cmd="dot -Txdot $dotfile | dot2tex > $dottex" ;;
esac

# Change to file directory
pushd . > /dev/null 2>&1
cd "$dotdir"

# Run
$dot_cmd

# View
[ -e "$dotpng" ] && $view_cmd "$dotpng" &

# Change to initial directory
popd > /dev/null 2>&1

exit 0

